<html>
<head>
<title>The City</title>
<script>
<!--
var initPop=[];

function fertilitybyage(age) {
	if (age>15 && age<24) {
		return (age-15)*250/8;
	}
	if (age>23 && age<32) {
		return 250-(age-23)*150/8;
	}
	if (age>31 && age<45) {
		return 100-(age-31)*100/14;
	}
	else return 0;
}

function musclebyage(age) {
	if (age<16) {
		return age*2;
	}
	if (age>15 && age<41) {
		return 30+(age-15)*4;
	}
	if (age>40 && age<86) {
		return 130-(age-40)*130/45;
	}
	else return 0;
}

for (var i=0; i<=50; i++) {
	initPop.push({
		'age':i,
		'population':100,
		'fertility':fertilitybyage(i),
		'age specific diseases':[],
		'muscle':musclebyage(i),
		'skills':{
			'gathering':[
				{'level':0,'population':1000}
			]
		}
	});
}


var stats={
	'population':{
		'by age':initPop,
		'totalPopulation':0,
		'diseases':{
			'malaria':{'name':'Malaria','infected':100,'infectionRate':0,'deathRate':0.00004,'transmissionRate':0.000000002},
			'tuberculosis':{'name':'Tuberculosis','infected':100,'infectionRate':0,'deathRate':0.00005,'immunityRate':0.0000212,'transmissionRate':0.000000009,'immunePopulation':0},
			'measles':{'name':'Measles','infected':100,'infectionRate':0,'deathRate':0.0000001,'immunityRate':0.02,'transmissionRate':0.002,'immunePopulation':0}
		},
		'consumptionRatio':0.1
	},
	'time':{'division':0,'day':0,'year':0},
	'resources':[{'name':'flowing water','daily amount':100000*24*3600,'daily consumption':0,'satisfaction rate':1},{'name':'fig','amount':10000,'calories':250},{'name':'olive','amount':500000,'calories':4},{'name':'plum','amount':5000,'calories':46},{'name':'pear','amount':50000,'calories':102},{'name':'raspberry','amount':50000,'calories':65},{'name':'grape','amount':5000,'calories':62},{'name':'apple','amount':50000,'calories':95},{'name':'orange','amount':50000,'calories':45}],
	'wildlife':{
		'mosquitoes': {
			'name':'Mosquitoes',
			'number':8000000,
			'diseases':{
				'malaria': {
					'name':'Malaria',
					'infected':0
				}
			}
		}
	},
	'stock':{
		'fig':10000000,
		'olive':0,
		'plum':0,
		'pear':0,
		'raspberry':0,
		'grape':0,
		'apple':0,
		'orange':0
	}
};

function diseaseReduction(disease) {
	return 1-disease.infectionRate*disease.deathRate;
}
function diseaseTotalReduction(diseases) {
	var result=1;
	for (var disease in diseases) {
		result*=diseaseReduction(diseases[disease]);
	}
	return result;
}

function startLoop() {
	setInterval(function(){
		
		var populationReduction=stats.resources[0]['satisfaction rate']*
			Math.min(1/stats.population.consumptionRatio,1)*
			diseaseTotalReduction(stats.population.diseases);
			
		stats.resources[0]['daily consumption']=0;
		stats.population.totalPopulation=0;
		var gatheringPower=0;
		for (var age=0;age<stats.population['by age'].length;age++) {
			//stats.population['by age'][age]['population']=stats.population['by age'][age]['population']*Math.pow(1-Math.min(0.0003*Math.pow(1.07,age),1),1/(365*5));
			
			stats.population['by age'][age]['population']*=populationReduction;
			
			stats.resources[0]['daily consumption']+=stats.population['by age'][age]['population']*0.08;
			stats.population.totalPopulation+=stats.population['by age'][age]['population'];
			
			for (var i=0;i<stats.population['by age'][age].skills.gathering.length;i++) {
				gatheringPower+=stats.population['by age'][age].skills.gathering[i].population*Math.sqrt(stats.population['by age'][age].skills.gathering[i].level*stats.population['by age'][age].muscle+1);
			}
		}
		stats.stock.fig+=stats.resources[1].amount*(1-Math.pow(1-1/stats.resources[1].amount,gatheringPower));
		stats.stock.olive+=stats.resources[2].amount*(1-Math.pow(1-1/stats.resources[2].amount,gatheringPower));
		stats.stock.plum+=stats.resources[3].amount*(1-Math.pow(1-1/stats.resources[3].amount,gatheringPower));
		stats.stock.pear+=stats.resources[4].amount*(1-Math.pow(1-1/stats.resources[4].amount,gatheringPower));
		stats.stock.raspberry+=stats.resources[5].amount*(1-Math.pow(1-1/stats.resources[5].amount,gatheringPower));
		stats.stock.grape+=stats.resources[6].amount*(1-Math.pow(1-1/stats.resources[6].amount,gatheringPower));
		stats.stock.apple+=stats.resources[7].amount*(1-Math.pow(1-1/stats.resources[7].amount,gatheringPower));
		stats.stock.orange+=stats.resources[8].amount*(1-Math.pow(1-1/stats.resources[8].amount,gatheringPower));
		
		var caloricNeeds=stats.population.totalPopulation*2000;
		var caloricStock=
			stats.resources[1].calories*stats.stock.fig+
			stats.resources[2].calories*stats.stock.olive+
			stats.resources[3].calories*stats.stock.plum+
			stats.resources[4].calories*stats.stock.pear+
			stats.resources[5].calories*stats.stock.raspberry+
			stats.resources[6].calories*stats.stock.grape+
			stats.resources[7].calories*stats.stock.apple+
			stats.resources[8].calories*stats.stock.orange;
		if (caloricStock!=0) {
			stats.population.consumptionRatio=caloricNeeds/caloricStock;
		}
		else {
			stats.population.consumptionRatio=10000000000000000000000000000000000000000;
			debugger;
		}
		
		if (stats.population.consumptionRatio<=1) {
			stats.stock.fig*=(1-stats.population.consumptionRatio);
			stats.stock.olive*=(1-stats.population.consumptionRatio);
			stats.stock.plum*=(1-stats.population.consumptionRatio);
			stats.stock.pear*=(1-stats.population.consumptionRatio);
			stats.stock.raspberry*=(1-stats.population.consumptionRatio);
			stats.stock.grape*=(1-stats.population.consumptionRatio);
			stats.stock.apple*=(1-stats.population.consumptionRatio);
			stats.stock.orange*=(1-stats.population.consumptionRatio);
		}
		else {
			stats.stock.fig=0;
		}
		//Malaria
		stats.population.diseases.malaria.infected*=populationReduction*(1-stats.population.diseases.malaria.deathRate)/(1-stats.population.diseases.malaria.infectionRate*stats.population.diseases.malaria.deathRate);
		
		stats.population.diseases.malaria.infected+=(stats.population.totalPopulation-stats.population.diseases.malaria.infected)*
		(1-Math.pow(1-stats.population.diseases.malaria.transmissionRate,stats.wildlife.mosquitoes.diseases.malaria.infected));
		
		stats.wildlife.mosquitoes.diseases.malaria.infected*=(1-1/200);
		stats.wildlife.mosquitoes.diseases.malaria.infected+=(stats.wildlife.mosquitoes.number-stats.wildlife.mosquitoes.diseases.malaria.infected)*
		(1-Math.pow(1-stats.population.diseases.malaria.transmissionRate,stats.population.diseases.malaria.infected));
		
		//Tuberculosis
		stats.population.diseases.tuberculosis.immunePopulation+=stats.population.diseases.tuberculosis.infected*stats.population.diseases.tuberculosis.immunityRate;
		stats.population.diseases.tuberculosis.immunePopulation*=populationReduction/(1-stats.population.diseases.tuberculosis.infectionRate*stats.population.diseases.tuberculosis.deathRate);

		stats.population.diseases.tuberculosis.infected*=populationReduction*(1-stats.population.diseases.tuberculosis.immunityRate)*(1-stats.population.diseases.tuberculosis.deathRate)/(1-stats.population.diseases.tuberculosis.infectionRate*stats.population.diseases.tuberculosis.deathRate);
		
		stats.population.diseases.tuberculosis.infected+=(stats.population.totalPopulation-stats.population.diseases.tuberculosis.infected-stats.population.diseases.tuberculosis.immunePopulation)*
		(1-Math.pow(1-stats.population.diseases.tuberculosis.transmissionRate,stats.population.diseases.tuberculosis.infected));
		
		//Measles
		stats.population.diseases.measles.immunePopulation+=stats.population.diseases.measles.infected*stats.population.diseases.measles.immunityRate;
		stats.population.diseases.measles.immunePopulation*=populationReduction/(1-stats.population.diseases.measles.infectionRate*stats.population.diseases.measles.deathRate);
		
		stats.population.diseases.measles.infected*=populationReduction*(1-stats.population.diseases.measles.immunityRate)*(1-stats.population.diseases.measles.deathRate)/(1-stats.population.diseases.measles.infectionRate*stats.population.diseases.measles.deathRate);
		
		
		stats.population.diseases.measles.infected+=(stats.population.totalPopulation-stats.population.diseases.measles.infected-stats.population.diseases.measles.immunePopulation)*
		(1-Math.pow(1-stats.population.diseases.measles.transmissionRate,stats.population.diseases.measles.infected));
		
		for (var disease in stats.population.diseases) {
			stats.population.diseases[disease].infectionRate=stats.population.diseases[disease].infected/stats.population.totalPopulation;
		}
		
		//Water
		if (stats.resources[0]['daily consumption']<stats.resources[0]['daily amount']) {
			stats.resources[0]['satisfaction rate']=1;
		}
		else {
			stats.resources[0]['satisfaction rate']=stats.resources[0]['daily amount']/stats.resources[0]['daily consumption'];
		}
		
		//remove nonexistent population ages
		while(stats.population['by age'][stats.population['by age'].length-1]['population']<0.5 && stats.population['by age'].length>50) {
			stats.population['by age'].pop();
		}
		//births
		for (var age=15;age<50;age++) {
			stats.population['by age'][0]['population']+=(stats.population['by age'][age]['fertility']*stats.population['by age'][age]['population']/1000/5/365);
		}
	
		if(stats.time.division<5) {
			stats.time.division++;
		}
		else {
			stats.time.division=0;
			if(stats.time.day<365) {
				stats.time.day++;
			}
			else {
				stats.time.day=0;
				stats.time.year++;
				for (var age=stats.population['by age'].length;age>0;age--) {
					if (stats.population['by age'][age]==null && stats.population['by age'][age-1]!=null) {
						stats.population['by age'].push({'age':age,'population':stats.population['by age'][age-1]['population'],'fertility':fertilitybyage(age),'age specific diseases':[],'muscle':musclebyage(i),'skills':{'gathering':[{'level':0,'population':100}]}});
					}
					else {
						stats.population['by age'][age]['population']=stats.population['by age'][age-1]['population'];
					}
				}
				stats.population['by age'][0]['population']=0;
			}
		}
		
		var newAgeList='';
		newAgeList+='<li>Total: '+Math.round(stats.population.totalPopulation)+'</li>';
		for (var age=0;age<stats.population['by age'].length;age++) {
			newAgeList+='<li>Age '+age+': '+Math.round(stats.population['by age'][age]['population'])+'</li>';
		}
		document.getElementById('time').innerHTML='Day '+stats.time.day+' Year '+stats.time.year;
		document.getElementById('water').innerHTML='Water available: '+stats.resources[0]['daily amount']+', Water used: '+Math.round(stats.resources[0]['daily consumption']);
		var foodList=
			'<li>Figs:'+Math.round(stats.resources[1].calories*stats.stock.fig)+'</li>'+
			'<li>Olive:'+Math.round(stats.resources[2].calories*stats.stock.olive)+'</li>'+
			'<li>Plum:'+Math.round(stats.resources[3].calories*stats.stock.plum)+'</li>'+
			'<li>Pear:'+Math.round(stats.resources[4].calories*stats.stock.pear)+'</li>'+
			'<li>Raspberry:'+Math.round(stats.resources[5].calories*stats.stock.raspberry)+'</li>'+
			'<li>Grape:'+Math.round(stats.resources[6].calories*stats.stock.grape)+'</li>'+
			'<li>Apple:'+Math.round(stats.resources[7].calories*stats.stock.apple)+'</li>'+
			'<li>Orange:'+Math.round(stats.resources[8].calories*stats.stock.orange)+'</li>';
		
		document.getElementById('food').innerHTML=foodList;
		document.getElementById('malaria').innerHTML='Malaria infections: '+Math.round(stats.population.diseases.malaria.infected)+', Infected mosquitoes: '+Math.round(stats.wildlife.mosquitoes.diseases.malaria.infected);
		document.getElementById('tuberculosis').innerHTML='Tuberculosis infections: '+Math.round(stats.population.diseases.tuberculosis.infected)+', Number immune: '+Math.round(stats.population.diseases.tuberculosis.immunePopulation);
		document.getElementById('measles').innerHTML='Measles infections: '+Math.round(stats.population.diseases.measles.infected)+', Number immune: '+Math.round(stats.population.diseases.measles.immunePopulation);
		document.getElementById('population').innerHTML=newAgeList;
		
	},1);
}

window.onload=startLoop();
-->
</script>
</head>
<body>
<p id="time"></p>
<p id="water"></p>
<ul id="food"></ul>
<p id="malaria"></p>
<p id="tuberculosis"></p>
<p id="measles"></p>

<ul id="population">
</ul>
</body>
</html>