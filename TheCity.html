<html>
<head>
<title>The City</title>
<script>
<!--
var initPop=[];

function fertilitybyage(age) {
	if (age>15 && age<24) {
		return (age-15)*250/8;
	}
	if (age>23 && age<32) {
		return 250-(age-23)*150/8;
	}
	if (age>31 && age<45) {
		return 100-(age-31)*100/14;
	}
	else return 0;
}

function musclebyage(age) {
	if (age<16) {
		return age*2;
	}
	if (age>15 && age<41) {
		return 30+(age-15)*4;
	}
	if (age>40 && age<86) {
		return 130-(age-40)*130/45;
	}
	else return 0;
}

for (var i=0; i<=50; i++) {
	initPop.push({
		'age':i,
		'population':100,
		'fertility':fertilitybyage(i),
		'age specific diseases':[],
		'muscle':musclebyage(i),
		'skills':{
			'gathering':[
				{'level':0,'population':100}
			]
		}
	});
}

var stats={
	'population':{
		'by age':initPop,
		'overall':{
			'total population':0,
			'diseases':[
				{'name':'malaria','infected':100,'infection rate':0,'death rate':0.00004,'transmission rate':0.000000002},
				{'name':'tuberculosis','infected':100,'infection rate':0,'death rate':0.00005,'immunity rate':0.0000212,'transmission rate':0.000000009,'immune population':0},
				{'name':'measles','infected':100,'infection rate':0,'death rate':0.0000001,'immunity rate':0.02,'transmission rate':0.002,'immune population':0}
			]
		}
	},
	'time':{'division':0,'day':0,'year':0},
	'resources':[{'name':'flowing water','daily amount':100000*24*3600,'daily consumption':0,'satisfaction rate':1},{'name':'fig','amount':500},{'name':'olive','amount':500},{'name':'plum','amount':500},{'name':'pear','amount':500},{'name':'berry','amount':500},{'name':'grape','amount':500},{'name':'apple','amount':500},{'name':'orange','amount':500}],
	'wildlife':[
		{
			'name':'mosquitoes',
			'number':8000000,
			'diseases':[
				{
					'name':'malaria',
					'infected':0
				}
			]
		}
	],
	'stock':{
		'fig':0,
		'olive':0,
		'plum':0,
		'pear':0,
		'berry':0,
		'grape':0,
		'apple':0,
		'orange':0
	}
};

function startLoop() {
	setInterval(function(){
		
		var populationReduction;
		stats.resources[0]['daily consumption']=0;
		stats.population.overall['total population']=0;
		for (var age=0;age<stats.population['by age'].length;age++) {
			//stats.population['by age'][age]['population']=stats.population['by age'][age]['population']*Math.pow(1-Math.min(0.0003*Math.pow(1.07,age),1),1/(365*5));
			
			populationReduction=stats.resources[0]['satisfaction rate']*
			(1-stats.population.overall.diseases[0]['infection rate']*stats.population.overall.diseases[0]['death rate'])*
			(1-stats.population.overall.diseases[1]['infection rate']*stats.population.overall.diseases[1]['death rate'])*
			(1-stats.population.overall.diseases[2]['infection rate']*stats.population.overall.diseases[2]['death rate']);
			
			stats.population['by age'][age]['population']*=populationReduction;
			
			stats.resources[0]['daily consumption']+=stats.population['by age'][age]['population']*0.08;
			stats.population.overall['total population']+=stats.population['by age'][age]['population'];
			
			var gatheringPower;
			for (var i=0;i<stats.population['by age'][age].skills.gathering.length;i++) {
				gatheringPower+=stats.population['by age'][age].skills.gathering[i].level*stats.population['by age'][age].skills.Math.sqrt(gathering[i]+1).population;
			}
			stats.stock.fig+=stats.resource[1].amount*(1-Math.pow(1-1/stats.resource[1].amount,gatheringPower*stats.population['by age'][age].muscle));
		}
		//Malaria
		stats.population.overall.diseases[0].infected*=populationReduction*(1-stats.population.overall.diseases[0]['death rate'])/(1-stats.population.overall.diseases[0]['infection rate']*stats.population.overall.diseases[0]['death rate']);
		stats.population.overall.diseases[0]['infection rate']=stats.population.overall.diseases[0].infected/stats.population.overall['total population'];
		
		stats.population.overall.diseases[0].infected+=(stats.population.overall['total population']-stats.population.overall.diseases[0].infected)*
		(1-Math.pow(1-stats.population.overall.diseases[0]['transmission rate'],stats.wildlife[0].diseases[0].infected));
		
		stats.wildlife[0].diseases[0].infected*=(1-1/200);
		stats.wildlife[0].diseases[0].infected+=(stats.wildlife[0]['number']-stats.wildlife[0].diseases[0].infected)*
		(1-Math.pow(1-stats.population.overall.diseases[0]['transmission rate'],stats.population.overall.diseases[0].infected));
		
		//Tuberculosis
		stats.population.overall.diseases[1]['immune population']+=stats.population.overall.diseases[1].infected*stats.population.overall.diseases[1]['immunity rate'];
		stats.population.overall.diseases[1]['immune population']*=populationReduction/(1-stats.population.overall.diseases[1]['infection rate']*stats.population.overall.diseases[1]['death rate']);
		
		stats.population.overall.diseases[1].infected*=populationReduction*(1-stats.population.overall.diseases[1]['immunity rate'])*(1-stats.population.overall.diseases[1]['death rate'])/(1-stats.population.overall.diseases[1]['infection rate']*stats.population.overall.diseases[1]['death rate']);
		stats.population.overall.diseases[1]['infection rate']=stats.population.overall.diseases[1].infected/stats.population.overall['total population'];
		
		stats.population.overall.diseases[1].infected+=(stats.population.overall['total population']-stats.population.overall.diseases[1].infected-stats.population.overall.diseases[1]['immune population'])*
		(1-Math.pow(1-stats.population.overall.diseases[1]['transmission rate'],stats.population.overall.diseases[1].infected));
		
		//Measles
		stats.population.overall.diseases[2]['immune population']+=stats.population.overall.diseases[2].infected*stats.population.overall.diseases[2]['immunity rate'];
		stats.population.overall.diseases[2]['immune population']*=populationReduction/(1-stats.population.overall.diseases[2]['infection rate']*stats.population.overall.diseases[2]['death rate']);
		
		stats.population.overall.diseases[2].infected*=populationReduction*(1-stats.population.overall.diseases[2]['immunity rate'])*(1-stats.population.overall.diseases[2]['death rate'])/(1-stats.population.overall.diseases[2]['infection rate']*stats.population.overall.diseases[2]['death rate']);
		
		
		stats.population.overall.diseases[2]['infection rate']=stats.population.overall.diseases[2].infected/stats.population.overall['total population'];
		
		stats.population.overall.diseases[2].infected+=(stats.population.overall['total population']-stats.population.overall.diseases[2].infected-stats.population.overall.diseases[2]['immune population'])*
		(1-Math.pow(1-stats.population.overall.diseases[2]['transmission rate'],stats.population.overall.diseases[2].infected));
		
		//Water
		if (stats.resources[0]['daily consumption']<stats.resources[0]['daily amount']) {
			stats.resources[0]['satisfaction rate']=1;
		}
		else {
			stats.resources[0]['satisfaction rate']=stats.resources[0]['daily amount']/stats.resources[0]['daily consumption'];
		}
		
		//remove nonexistent population ages
		while(stats.population['by age'][stats.population['by age'].length-1]['population']<0.5) {
			stats.population['by age'].pop();
		}
		//births
		for (var age=15;age<50;age++) {
			stats.population['by age'][0]['population']+=(stats.population['by age'][age]['fertility']*stats.population['by age'][age]['population']/1000/5/365);
		}
	
		if(stats.time.division<5) {
			stats.time.division++;
		}
		else {
			stats.time.division=0;
			if(stats.time.day<365) {
				stats.time.day++;
			}
			else {
				stats.time.day=0;
				stats.time.year++;
				for (var age=stats.population['by age'].length;age>0;age--) {
					if (stats.population['by age'][age]==null && stats.population['by age'][age-1]!=null) {
						stats.population['by age'].push({'age':age,'population':stats.population['by age'][age-1]['population'],'fertility':fertilitybyage(age)});
					}
					else {
						stats.population['by age'][age]['population']=stats.population['by age'][age-1]['population'];
					}
				}
				stats.population['by age'][0]['population']=0;
			}
		}
		
		var newAgeList='';
		newAgeList+='<li>Total: '+stats.population.overall['total population']+'</li>';
		for (var age=0;age<stats.population['by age'].length;age++) {
			newAgeList+='<li>Age '+age+': '+Math.round(stats.population['by age'][age]['population'])+'</li>';
		}
		document.getElementById('time').innerHTML='Day '+stats.time.day+' Year '+stats.time.year;
		document.getElementById('water').innerHTML='Water available: '+stats.resources[0]['daily amount']+', Water used: '+stats.resources[0]['daily consumption'];
		document.getElementById('fig').innerHTML='Figs: '+stats.stock.fig;
		document.getElementById('malaria').innerHTML='Malaria infections: '+stats.population.overall.diseases[0].infected+', Infected mosquitoes: '+stats.wildlife[0].diseases[0].infected;
		document.getElementById('tuberculosis').innerHTML='Tuberculosis infections: '+stats.population.overall.diseases[1].infected+', Number immune: '+stats.population.overall.diseases[1]['immune population'];
		document.getElementById('measles').innerHTML='Measles infections: '+stats.population.overall.diseases[2].infected+', Number immune: '+stats.population.overall.diseases[2]['immune population'];
		document.getElementById('population').innerHTML=newAgeList;
		
	},1);
}

window.onload=startLoop();
-->
</script>
</head>
<body>
<p id="time"></p>
<p id="water"></p>
<p id="fig"></p>
<p id="malaria"></p>
<p id="tuberculosis"></p>
<p id="measles"></p>

<ul id="population">
</ul>
</body>
</html>